package io.github.confuser2188.exploitguard;

import org.bukkit.entity.Player;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;

public class Logger {

    class LogInfo
    {
        String lastPacketName = "";
        int count = 1;
    }

    private HashMap<Player, LogInfo> logInfoHashMap = new HashMap<>();

    private LogInfo getLogInfo(Player p)
    {
        if(!logInfoHashMap.containsKey(p))
        {
            LogInfo logInfo = new LogInfo();
            logInfoHashMap.put(p, logInfo);
            return logInfo;
        }else{
            return logInfoHashMap.get(p);
        }
    }

    public void tick(Player p, Object packet)
    {
        String packetName = packet.getClass().getSimpleName();

        LogInfo logInfo = getLogInfo(p);

        if(logInfo.lastPacketName.equals(packetName))
        {
            logInfo.count++;
        }else if(logInfo.lastPacketName.isEmpty()) {
            logInfo.lastPacketName = packetName;
            logInfo.count = 1;
        }else{
            String msg = p.getName() + " -> " + logInfo.lastPacketName;

            if(logInfo.count != 1)
                msg += " [x" + logInfo.count + "]";

            log(msg);

            logInfo.lastPacketName = packetName;
            logInfo.count = 1;
        }
    }

    private void log(String message)
    {
        Date now = new Date();
        SimpleDateFormat format = new SimpleDateFormat("HH:mm:ss");

        message = "[" + format.format(now) + "] " + message;

        try
        {
            File dataFolder = Main.plugin.getDataFolder();
            if(!dataFolder.exists())
                dataFolder.mkdir();

            File logFolder = new File(Main.plugin.getDataFolder() + "/logs");
            if(!logFolder.exists())
                logFolder.mkdir();

            SimpleDateFormat formaty = new SimpleDateFormat("dd-MM-yyyy");
            String str = formaty.format(now);

            File saveTo = new File(Main.plugin.getDataFolder() + "/logs/", str + ".log");
            if (!saveTo.exists())
                saveTo.createNewFile();


            FileWriter fw = new FileWriter(saveTo, true);
            PrintWriter pw = new PrintWriter(fw);
            pw.println(message);
            pw.flush();
            pw.close();

        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }
}
