package io.github.confuser2188.exploitguard;

import io.github.confuser2188.exploitguard.module.Module;
import io.github.confuser2188.exploitguard.module.ModuleManager;
import io.github.confuser2188.packetlistener.PacketListener;
import org.bukkit.Bukkit;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.java.JavaPlugin;

import java.io.File;

public class Main extends JavaPlugin{

    private final int CONFIG_VERSION = 2;
    public static Logger logger = new Logger();
    private PacketListener packetListener;
    public static Plugin plugin;

    public void onEnable() {
        plugin = this;

        // Enable command
        Bukkit.getPluginCommand("exploitguard").setExecutor(new Command());

        // Config things
        saveDefaultConfig();
        this.checkConfig();

        // Enable modules
        ModuleManager moduleManager = new ModuleManager();
        moduleManager.setup();
        moduleManager.mods.forEach(Module::onEnable);

        // Register events
        packetListener = new PacketListener();
        Bukkit.getPluginManager().registerEvents(packetListener, this);

        // Add players
        Bukkit.getOnlinePlayers().forEach(packetListener::addPlayer);
    }

    public void onDisable() {
        // Remove players
        Bukkit.getOnlinePlayers().forEach(packetListener::removePlayer);
    }

    private void checkConfig()
    {
        FileConfiguration config = this.getConfig();
        if(config.getString("config_version") == null || !config.getString("config_version").equalsIgnoreCase("" + CONFIG_VERSION))
        {
            File file = new File(getDataFolder(), "config.yml");
            if(file.exists())
            {
                File file2 = new File(getDataFolder(), "config_old.yml");
                if(file2.exists())
                    file2.delete();

                file.renameTo(new File(getDataFolder(), "config_old.yml"));
                saveDefaultConfig();
            }
        }
    }

    public static String getServerVersion() {
        try {
            return Bukkit.getServer().getClass().getPackage().getName().replace(".",  ",").split(",")[3];
        } catch (Exception ex) {
            ex.printStackTrace();
            return "null";
        }
    }

    public static String applyColor(String str) {
        return str.replace("&", "ยง");
    }
}
