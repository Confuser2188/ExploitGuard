package io.github.confuser2188.exploitguard.module.check;

import io.github.confuser2188.exploitguard.Action;
import io.github.confuser2188.exploitguard.Main;
import io.github.confuser2188.exploitguard.module.Check;
import io.github.confuser2188.exploitguard.module.Module;
import io.github.confuser2188.packetlistener.FieldName;
import io.github.confuser2188.packetlistener.Reflection;
import io.github.confuser2188.packetlistener.event.ReceivedPacketEvent;
import io.github.confuser2188.packetlistener.minecraft.*;
import io.netty.buffer.ByteBuf;
import org.bukkit.event.EventHandler;

public class ItemNBT extends Module{

    public ItemNBT() {
        super(Check.ITEM_NBT);
    }

    @EventHandler
    public void onPacketReceive(ReceivedPacketEvent event) {
        if (!this.isEnabled())
            return;

        try
        {
            ItemStack itemStack = null;

            switch(event.getPacketName())
            {
                case "PacketPlayInSetCreativeSlot":
                    itemStack = new ItemStack(Reflection.getFieldValue(event.getPacket(), "b"));
                    break;
                case "PacketPlayInWindowClick":
                    itemStack = new ItemStack(Reflection.getFieldValue(event.getPacket(), "item"));
                    break;
                case "PacketPlayInBlockPlace":
                    // ItemStack field removed in newer versions. So exploit is fixed
                    if(Main.getServerVersion().startsWith("v1_8"))
                        itemStack = new ItemStack(Reflection.getFieldValue(event.getPacket(), "d"));
                    break;
                case "PacketPlayInCustomPayload":
                    String channel = PayloadChannel.getChannel(event.getPacket());

                    if(channel.equals("MC|BSign") || channel.equals("MC|BEdit")){
                        PacketDataSerializer packetDataSerializer = new PacketDataSerializer(Reflection.getFieldValue(event.getPacket(), FieldName.PACKETDATASERIALIZER.getName()));

                        ByteBuf byteBuf = packetDataSerializer.getByteBuf().copy();

                        short short0 = packetDataSerializer.readShort();
                        if(short0 >= 0) {
                            packetDataSerializer.readByte();
                            packetDataSerializer.readShort();

                            NBTTagCompound nbtTagCompound = packetDataSerializer.getNBTTagCompound();
                            if(checkInvalidNBT(nbtTagCompound))
                            {
                                Action.run(event.getPlayer(), this.getCheckType());
                                event.setCancelled(true);
                            }
                        }

                        Reflection.setFieldValue(packetDataSerializer.getPacketDataSerializerObject(), "a", byteBuf);
                        if(event.isCancelled()) return;
                    }
                    break;
            }

            if(itemStack != null)
            {
                if(this.checkInvalidNBT(itemStack))
                {
                    Action.run(event.getPlayer(), this.getCheckType());
                    event.setCancelled(true);
                }
            }
        }catch(Exception ex) { ex.printStackTrace(); }
    }

    private boolean checkInvalidNBT(ItemStack itemStack) throws Exception{
        if (itemStack.getItemStackObject() == null || itemStack.getItem().getItem() == null || itemStack.getItem().getName() == null) {
            return false;
        }

        String itemName = itemStack.getItem().getName();

        // Book NBT
        if (itemName.equals("book")
                || itemName.equals("writingBook")
                || itemName.equals("writtenBook")) {
            NBTTagCompound tagCompound = new NBTTagCompound(itemStack.getItemStackObject());
            return this.checkInvalidNBT(tagCompound);
        }
        return false;
    }

    private boolean checkInvalidNBT(NBTTagCompound tagCompound) throws Exception{
        if (tagCompound.isValid() && tagCompound.hasKey("pages")) {
            NBTTagList list = tagCompound.getList("pages", 8);

            // Whitelist for Essentials "/kit color" book
            //if (list.size() == 1 && list.getString(0).length() <= 1120) return false;

            if (list.size() > 50)
                return true;
            else if (list.size() >= 1)
                for (int i = 0; i < list.size(); i++)
                    if (list.getString(i).length() > 275)
                        return true;
        }
        return false;
    }
}
