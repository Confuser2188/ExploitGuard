package io.github.confuser2188.exploitguard.module.check;

import io.github.confuser2188.exploitguard.Action;
import io.github.confuser2188.exploitguard.module.Check;
import io.github.confuser2188.exploitguard.module.Module;
import io.github.confuser2188.packetlistener.FieldName;
import io.github.confuser2188.packetlistener.Reflection;
import io.github.confuser2188.packetlistener.event.ReceivedPacketEvent;
import io.github.confuser2188.packetlistener.minecraft.BlockPosition;
import io.github.confuser2188.packetlistener.minecraft.TileEntity;
import io.github.confuser2188.packetlistener.minecraft.TileEntitySign;
import io.github.confuser2188.packetlistener.minecraft.WorldServer;
import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;

public class NonEditableSign extends Module{

    public NonEditableSign() {
        super(Check.NON_EDITABLE_SIGN);
    }

    @EventHandler
    public void onPacketReceive(ReceivedPacketEvent event) {
        if (!this.isEnabled() || !event.getPacketName().equals("PacketPlayInUpdateSign"))
            return;

        if(!event.getPlayer().isDead())
        {
            try {
                BlockPosition blockPos = new BlockPosition(Reflection.getFieldValue(event.getPacket(), "a"));
                WorldServer worldServer = new WorldServer(Reflection.getWorldServer(event.getPlayer().getWorld()));

                if(worldServer.isLoaded(blockPos))
                {
                    TileEntity tileEntity = worldServer.getTileEntity(blockPos);
                    if(tileEntity.getTileEntityObject().getClass().getSimpleName().equals("TileEntitySign"))
                    {
                        TileEntitySign tileEntitySign = new TileEntitySign(tileEntity.getTileEntityObject());
                        if(!tileEntitySign.isEditable())
                        {
                            Action.run(event.getPlayer(), this.getCheckType());
                            event.setCancelled(true);
                        }
                    }
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
